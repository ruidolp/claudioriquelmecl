<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidsPlay - Editor de Videos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .admin-container { max-width: 1200px; margin: 0 auto; }
        .video-item { transition: all 0.3s ease; }
        .video-item:hover { background-color: #f8fafc; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); z-index: 1000; display: none; }
        .notification { position: fixed; top: 20px; right: 20px; z-index: 1001; max-width: 400px; transform: translateX(100%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left-color: #10b981; }
        .notification.error { border-left-color: #ef4444; }
        .url-input { font-family: 'Courier New', monospace; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .add-form { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .video-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .video-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1); }
        .video-thumbnail { position: relative; overflow: hidden; }
        .video-thumbnail img { width: 100%; height: 180px; object-fit: cover; transition: transform 0.3s ease; }
        .video-card:hover .video-thumbnail img { transform: scale(1.05); }
        .play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.7); border-radius: 50%; padding: 12px; }
        .video-info { padding: 1.5rem; }
        .video-title { font-size: 1.1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; line-height: 1.4; }
        .video-url { font-size: 0.875rem; color: #6b7280; font-family: 'Courier New', monospace; word-break: break-all; margin-bottom: 1rem; }
        .video-actions { display: flex; justify-content: space-between; align-items: center; }
        .btn-primary { background: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: background 0.2s ease; }
        .btn-primary:hover { background: #dc2626; }
        .btn-secondary { background: #f3f4f6; color: #374151; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: background 0.2s ease; }
        .btn-secondary:hover { background: #e5e7eb; }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .loading-skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 12px; height: 320px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Sincronizando con Edge Config...</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="bg-white border-l-4 p-4 shadow-lg rounded-r-lg">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg id="notification-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p id="notification-message" class="text-sm font-medium text-gray-900"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="admin-container px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">KidsPlay Editor</h1>
                        <p class="text-gray-600">Gestiona tu colección de videos seguros</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.open('kidsplay-viewer.html', '_blank')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Ver KidsPlay
                    </button>
                    <button onclick="loadVideos()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="admin-container px-6 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stats-card text-white p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">Total Videos</p>
                        <p id="total-count" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Estado</p>
                        <p id="sync-status" class="text-lg font-semibold text-green-600">Conectado</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Última actualización</p>
                        <p id="last-update" class="text-lg font-semibold text-gray-900">-</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                            <path d="m12.5 7-1 0v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Video Form -->
        <div class="add-form text-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-bold mb-4">➕ Agregar nuevo video</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Nombre del video</label>
                    <input 
                        type="text" 
                        id="video-name" 
                        placeholder="Ej: Canción de los animales de la granja"
                        class="w-full px-4 py-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-white"
                    >
                </div>
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">URL de YouTube</label>
                    <div class="flex space-x-4">
                        <input 
                            type="url" 
                            id="video-url" 
                            placeholder="https://www.youtube.com/watch?v=..."
                            class="flex-1 px-4 py-3 rounded-lg text-gray-900 url-input focus:outline-none focus:ring-2 focus:ring-white"
                        >
                        <button 
                            onclick="addVideo()" 
                            class="px-6 py-3 bg-white text-red-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors"
                        >
                            Guardar Video
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-white/80 text-sm mt-2">
                Formatos soportados: youtube.com/watch?v=ID, youtu.be/ID
            </p>
        </div>

        <!-- Videos Grid -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="px-6 py-4 border-b bg-gray-50">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">📋 Colección de videos</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Videos:</span>
                        <span id="loaded-count" class="font-semibold text-gray-900">0</span>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div id="videos-container" class="video-grid">
                    <!-- Loading skeletons -->
                    <div class="loading-skeleton"></div>
                    <div class="loading-skeleton"></div>
                    <div class="loading-skeleton"></div>
                </div>
            </div>
        </div>

        <!-- Edge Config Info -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">⚡ Conectado a Vercel Edge Config</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
                <div>
                    <p><strong>Edge Config ID:</strong> <code class="bg-blue-100 px-2 py-1 rounded text-xs">ecfg_lbbhs630xxkrlqefuteszrmtso5m</code></p>
                    <p class="mt-2"><strong>Ventajas:</strong> Ultra-rápido globalmente, 99% de uptime, sin límites</p>
                </div>
                <div>
                    <p><strong>Token:</strong> <code class="bg-blue-100 px-2 py-1 rounded text-xs">32fe5313-***-***</code></p>
                    <p class="mt-2"><strong>Sincronización:</strong> Los cambios se reflejan instantáneamente en el visor</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACIÓN EDGE CONFIG =====
        const EDGE_CONFIG_ID = 'ecfg_lbbhs630xxkrlqefuteszrmtso5m';
        const EDGE_CONFIG_TOKEN = '32fe5313-9a5e-4f7e-9d33-85654ad9ba4b';
        const EDGE_CONFIG_URL = `https://edge-config.vercel.com/${EDGE_CONFIG_ID}?token=${EDGE_CONFIG_TOKEN}`;
        const VIDEO_LIST_KEY = 'videoList'; // Clave donde se almacenan los videos

        let videos = [];
        let isLoading = false;

        // Función para extraer ID de YouTube
        function extractVideoId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : null;
        }

        // Cargar videos desde Edge Config
        async function loadVideos() {
            if (isLoading) return;
            
            setLoading(true);
            setSyncStatus('Cargando...', 'text-yellow-600');
            
            try {
                console.log('Cargando videos desde Edge Config...');
                
                const response = await fetch(EDGE_CONFIG_URL, {
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                videos = data[VIDEO_LIST_KEY] || [];
                
                console.log('Videos cargados:', videos.length);
                
                displayVideos();
                updateStats();
                setSyncStatus('Sincronizado', 'text-green-600');
                showNotification('Videos cargados correctamente', 'success');
                
            } catch (error) {
                console.error('Error cargando videos:', error);
                setSyncStatus('Error', 'text-red-600');
                showNotification('Error al cargar videos: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Guardar videos en Edge Config
        async function saveVideos() {
            if (isLoading) return;
            
            setLoading(true);
            setSyncStatus('Guardando...', 'text-yellow-600');
            
            try {
                console.log('Guardando videos en Edge Config...');
                
                // Usar la API REST de Vercel para actualizar Edge Config
                const response = await fetch(`https://api.vercel.com/v1/edge-config/${EDGE_CONFIG_ID}/items`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${EDGE_CONFIG_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: [
                            {
                                operation: 'upsert',
                                key: VIDEO_LIST_KEY,
                                value: videos
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Error ${response.status}: ${errorData}`);
                }
                
                const result = await response.json();
                console.log('Videos guardados:', result);
                
                setSyncStatus('Sincronizado', 'text-green-600');
                updateStats();
                showNotification('Videos guardados correctamente', 'success');
                
            } catch (error) {
                console.error('Error guardando videos:', error);
                setSyncStatus('Error', 'text-red-600');
                showNotification('Error al guardar videos: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Agregar nuevo video
        async function addVideo() {
            const nameInput = document.getElementById('video-name');
            const urlInput = document.getElementById('video-url');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name) {
                showNotification('Por favor ingresa un nombre para el video', 'error');
                nameInput.focus();
                return;
            }
            
            if (!url) {
                showNotification('Por favor ingresa una URL', 'error');
                urlInput.focus();
                return;
            }
            
            const videoId = extractVideoId(url);
            
            if (!videoId) {
                showNotification('URL de YouTube inválida', 'error');
                urlInput.focus();
                return;
            }
            
            // Verificar si ya existe
            if (videos.some(video => video.url === url)) {
                showNotification('Esta URL ya está en la lista', 'error');
                return;
            }
            
            // Agregar a la lista
            videos.push({
                nombre: name,
                url: url
            });
            
            // Limpiar inputs
            nameInput.value = '';
            urlInput.value = '';
            
            // Guardar inmediatamente
            await saveVideos();
            
            // Actualizar vista
            displayVideos();
        }

        // Eliminar video
        async function removeVideo(index) {
            const video = videos[index];
            if (!confirm(`¿Estás seguro de que quieres eliminar "${video.nombre}"?`)) {
                return;
            }
            
            videos.splice(index, 1);
            
            // Guardar inmediatamente
            await saveVideos();
            
            // Actualizar vista
            displayVideos();
        }

        // Mostrar videos en la interfaz
        function displayVideos() {
            const container = document.getElementById('videos-container');
            container.innerHTML = '';
            
            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state col-span-full">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <p class="text-lg font-medium">No hay videos</p>
                        <p class="text-sm">Agrega tu primer video usando el formulario de arriba</p>
                    </div>
                `;
                return;
            }
            
            videos.forEach((video, index) => {
                const videoElement = createVideoCard(video, index);
                container.appendChild(videoElement);
            });
        }

        // Crear tarjeta de video
        function createVideoCard(video, index) {
            const videoId = extractVideoId(video.url);
            
            const div = document.createElement('div');
            div.className = 'video-card';
            
            div.innerHTML = `
                <div class="video-thumbnail">
                    <img 
                        src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" 
                        alt="${video.nombre}"
                        onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'"
                    >
                    <div class="play-overlay">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                </div>
                <div class="video-info">
                    <h3 class="video-title">${video.nombre}</h3>
                    <p class="video-url">${video.url}</p>
                    <div class="video-actions">
                        <button 
                            onclick="window.open('${video.url}', '_blank')"
                            class="btn-secondary"
                        >
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                            </svg>
                            Ver
                        </button>
                        <button 
                            onclick="removeVideo(${index})"
                            class="btn-primary"
                        >
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('total-count').textContent = videos.length;
            document.getElementById('loaded-count').textContent = videos.length;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Estado de carga
        function setLoading(loading) {
            isLoading = loading;
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = loading ? 'flex' : 'none';
        }

        // Estado de sincronización
        function setSyncStatus(status, className) {
            const element = document.getElementById('sync-status');
            element.textContent = status;
            element.className = `text-lg font-semibold ${className}`;
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notification-message');
            const iconElement = document.getElementById('notification-icon');
            
            messageElement.textContent = message;
            
            // Cambiar icono y color según el tipo
            notification.className = `notification ${type} show`;
            
            if (type === 'error') {
                iconElement.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>`;
                iconElement.className = 'w-5 h-5 text-red-500';
            } else {
                iconElement.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>`;
                iconElement.className = 'w-5 h-5 text-green-500';
            }
            
            setTimeout(() => hideNotification(), 5000);
        }

        // Ocultar notificación
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // Enter key en inputs
        document.getElementById('video-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('video-url').focus();
            }
        });

        document.getElementById('video-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addVideo();
            }
        });

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadVideos();
        });
    </script>
</body>
</html>
